# 產品需求文件 (PRD)
**專案名稱：** Minervini 趨勢樣板選股系統 (MTTS)
**版本：** 1.1 (修訂版)
**狀態：** 已核准開發 (Approved for Development)
**日期：** 2026-02-10

---

## 1. 簡介 (Introduction)
### 1.1 目的 (Purpose)
本專案旨在自動化執行 Mark Minervini 的「趨勢樣板」（Trend Template，即第二階段多頭趨勢）選股策略。系統將攝取台灣股市 (TWSE/TPEX) 的歷史數據，計算技術指標，針對全市場進行相對強度 (RS) 排名，並篩選出具備高流動性且符合強勢型態的優質股票。

### 1.2 範圍 (Scope)
- **目標市場：** 台灣證券交易所 (TWSE) 與 證券櫃檯買賣中心 (TPEX)。
- **資產類別：** **僅限普通股 (Common Stocks Only)**（嚴格排除 ETF、TDR、權證與特別股）。
- **數據來源：** Yahoo Finance (`yfinance`) API + `twstock` (用於股票分類)。
- **輸出產物：** 包含通過/失敗狀態、失敗原因及具體技術指標數據的綜合報表 (CSV/JSON)。

---

## 2. 功能需求 (Functional Requirements - FR)

### FR-01: 股票池管理 (嚴格過濾)
- **函式庫依賴：** 系統必須使用 `twstock` 函式庫（或其他官方對應來源）來獲取最新的股票代碼清單。
- **過濾規則：** 在抓取股價數據**之前**，必須先針對股票池進行嚴格過濾，以節省運算資源：
    - **保留 (Include)：** 類別 = "股票" (Common Stock)。
    - **排除 (Exclude)：**
        - ETF (00xx 系列)
        - TDR 台灣存託憑證 (91xx 系列)
        - 權證 (03xx-08xx)
        - 特別股 (後綴為 A/B/C)
        - 全額交割股 (若能透過 Metadata 識別)。

### FR-02: 數據攝取與 IPO 處理
- **批次處理 (Batch Processing)：** 必須使用多執行緒並發 (Concurrent) 抓取歷史 OHLCV 數據。
- **歷史長度：** 請求區間 `period="1y"` (約 250-260 個交易日)。
- **數據完整性：** 必須使用 **「還原權值收盤價」 (Adjusted Close)** 以修正除權息影響。
- **異常處理 (IPO 規則)：**
    - 若某檔股票的歷史交易日少於 **250 天** (近期 IPO 新股)，系統必須**自動排除**該股票。
    - **Log 記錄：** 記錄警告訊息 "Skipped: Insufficient Data (<250 days)"，但**不可**導致程式崩潰。

### FR-03: 技術分析引擎 (雙重掃描邏輯)
為了確保相對強度 (RS) 計算的準確性，系統必須分為兩個階段執行：

- **第一階段：個股指標運算 (Pass 1 - Per Stock)**
    - **移動平均線 (SMA)：** 50日, 150日, 200日。
    - **價格極值：** 52週最高價 / 52週最低價 (Rolling 252 days)。
    - **趨勢斜率：** 定義為 `目前 SMA_200 > 20天前的 SMA_200`。
    - **ROC (變動率)：** 計算近 1 年的股價漲幅，作為 RS 計算基礎。

- **第二階段：全市場排名 (Pass 2 - Market Ranking)**
    - **RS 分數計算：** 收集所有有效股票的 1 年 ROC 數據，進行排序，並給予 **0-99 的百分位數 (Percentile Score)**。
    - *備註：* RS 分數不能單獨計算，必須依賴全市場數據。

### FR-04: 篩選邏輯 (8+1 條件)
系統必須驗證以下條件，**全部 (ALL)** 為真才視為「通過 (PASS)」：

1.  **價格位置：** 目前股價 > 150 SMA > 200 SMA。
2.  **長期均線排列：** 150 SMA > 200 SMA。
3.  **200 SMA 趨勢：** `SMA_200_Current` > `SMA_200_20_Days_Ago` (簡單斜率檢查)。
4.  **中長期均線排列：** 50 SMA > 150 SMA **且** 50 SMA > 200 SMA。
5.  **動能確認：** 目前股價 > 50 SMA。
6.  **底部支撐：** 目前股價高於 52週最低價至少 **30%** (可配置)。
7.  **消化賣壓：** 目前股價處於 52週最高價的 **25%** 範圍內 (可配置)。
8.  **相對強度：** RS 分數 >= **70** (優於市場 70% 的股票)。

### FR-05: 詳細輸出與可解釋性
- **需求：** 輸出結果不能只有二分法，對於「差一點就符合 (Near Miss)」的股票，需解釋原因。
- **報表欄位 (CSV/JSON)：**
    - `Ticker` (代碼), `Name` (名稱), `Sector` (產業)
    - `Status`: **PASS** / **FAIL**
    - `Failure_Reason`: (例如 "Volume Too Low", "RS<70", "Below 200MA") - 若失敗，列出首要原因。
    - `Match_Count`: (例如 "8/8" 或 "6/8")
    - `Liquidity_Check`: Boolean (流動性檢查結果)。
    - `RS_Rating`: Integer (0-99)。
    - `Vol_Avg_20d`: 20日均量 (股數)。

### FR-06: 流動性與品質過濾 (新增)
為了防止「殭屍股」(無量個股) 出現在篩選結果中：
- **條件 A (成交量)：** 20日平均成交量 > **500,000 股** (即 500 張)。
- **條件 B (成交值 - 選用)：** 20日平均成交金額 > **1,000 萬台幣**。
- **動作：** 若股票未通過此檢查，無論技術型態多好，直接標記為 `FAIL (Liquidity)`。

---

## 3. 非功能需求 (Non-Functional Requirements - NFR)

### NFR-01: 效能與可靠性 (Performance & Reliability)
- **快取策略 (關鍵)：** 系統必須實作 **「每日地端快取」** 機制 (例如 `./cache/market_data_YYYY-MM-DD.pkl`)。
    - **邏輯：** 程式執行時，先檢查是否有當日的快取檔。若有，直接讀取；若無，才呼叫 API 並存檔。
    - **效益：** 防止 API 因頻繁請求而 Ban IP，並大幅加速開發測試流程。

### NFR-02: 可擴展性 (Scalability)
- **並發性：** 數據抓取階段必須使用 `ThreadPoolExecutor`。
- **記憶體管理：** RS 排名運算應使用 Pandas 的向量化操作 (Vectorized Operations)，避免使用 Python 迴圈，以確保效能。

### NFR-03: 可配置性 (Configurability)
- **設定檔：** 關鍵閾值必須提取至 `config.py` 或 `.env` 檔案，而非寫死在程式碼中：
    - `RS_THRESHOLD = 70` (RS 門檻)
    - `DIST_FROM_LOW = 1.30` (距離低點 30%)
    - `DIST_FROM_HIGH = 0.75` (距離高點 25%)
    - `MIN_AVG_VOLUME = 500000` (最小均量)